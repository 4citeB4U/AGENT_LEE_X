<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VITS-Web TTS Test (CDN)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; background:#0a0f12; color:#e6f0ff; }
    .card { max-width: 820px; margin: 0 auto; background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 16px; }
    button { padding: 10px 14px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#13202f; color:#e6f0ff; cursor:pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 8px; border:1px solid rgba(255,255,255,0.2); background:#0f1725; color:#e6f0ff; }
  .sr-only { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .muted { color:#9fb0c7; }
    #status { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>AI Voice Test (CDN Version)</h1>
    <div class="row">
      <button id="downloadBtn">Download Voice Model</button>
      <button id="speakBtn" disabled>Speak Test</button>
    </div>
    <p class="muted">Default voice: <code>en_US-hfc_female-medium</code>. Use the list in the console to try others.</p>
  <label for="textInput" class="sr-only">Text to speak</label>
  <input type="text" id="textInput" value="Hello! I'm your AI assistant with a natural voice." placeholder="Enter text to speak" title="Text to speak" aria-label="Text to speak" />
    <div id="status" class="muted"></div>
  </div>

  <script crossorigin="anonymous" type="module">
    // Prefer the local assets proxy when available so COEP/COOP and caching are under our control.
    // Dynamically import the proxied build first; fall back to the CDN only if needed.
    let tts = window['vits'] ?? null;

    (async function loadVits() {
      try {
        const proxied = '/assets/cdn.jsdelivr.net/npm/@diffusionstudio/vits-web@latest/dist/vits-web.js';
        try {
          const m = await import(proxied);
          window['vits'] = m;
          tts = m;
          return;
        } catch (e) {
          // ignore proxied failure and try CDN next
        }

        const cdn = 'https://cdn.jsdelivr.net/npm/@diffusionstudio/vits-web@latest/dist/vits-web.js';
        try {
          const m = await import(cdn);
          window['vits'] = m;
          tts = m;
        } catch (e) {
          console.error('[VITS] both proxied and CDN imports failed', e);
        }
      } catch (e) {
        console.error('[VITS] import flow error', e);
      }
    })();

    const downloadBtn = document.getElementById('downloadBtn');
    const speakBtn = document.getElementById('speakBtn');
    const textInput = document.getElementById('textInput');
    const status = document.getElementById('status');

    let currentVoice = 'en_US-hfc_female-medium';

    async function ensureTtsReady(timeout = 10000) {
      const start = Date.now();
      while (!tts && (Date.now() - start) < timeout) {
        await new Promise(r => setTimeout(r, 100));
      }
      if (!tts) throw new Error('VITS library not loaded');
      return tts;
    }

    downloadBtn.addEventListener('click', async () => {
      try {
        status.textContent = 'Downloading voice model...';
        const lib = await ensureTtsReady();
        await lib.download(currentVoice, (progress) => {
          const pct = progress.total ? Math.round(progress.loaded * 100 / progress.total) : 0;
          status.textContent = `Downloading ${pct}%`;
        });
        status.textContent = 'Voice model downloaded! Ready to speak.';
        speakBtn.disabled = false;
      } catch (error) {
        console.error(error);
        status.textContent = 'Error downloading model: ' + (error?.message || error);
      }
    });

    speakBtn.addEventListener('click', async () => {
      try {
        status.textContent = 'Generating speech...';
        const wav = await tts.predict({ text: textInput.value, voiceId: currentVoice });
        const audio = new Audio();
        audio.src = URL.createObjectURL(wav);
        await audio.play();
        status.textContent = 'Playing audio...';
      } catch (error) {
        console.error(error);
        status.textContent = 'Error generating speech: ' + (error?.message || error);
      }
    });

    // Log available voices and auto-enable if already stored
    try {
      const lib = await ensureTtsReady(3000);
      const voices = await lib.voices();
      console.log('Available voices:', voices);
      // Pick a deep male voice if present
      const preferred = ['en_US-hfc_male-medium','en_US-hfc_male-low','en_US-hfc_male-high'];
      for (const v of preferred) { if (voices.includes(v)) { currentVoice = v; break; } }

  const models = await lib.stored();
      if (models.includes(currentVoice)) {
        status.textContent = `Voice ${currentVoice} already available! Ready to speak.`;
        speakBtn.disabled = false;
      }
    } catch (e) {
      console.warn('Could not query voices/stored:', e);
    }
  </script>
</body>
</html>
